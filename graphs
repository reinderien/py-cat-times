#!/usr/bin/env R --vanilla -q -f
options(echo=F)

library(ggplot2)
library(scales)


# Data #####################################################################

times = transform(read.csv('times.csv'),
                  Throughput=Size/Duration)


# Plot utilities ###########################################################
# Lifted directly from
# https://github.com/reinderien/capmeter/blob/master/range-analysis.r

# Adapted from https://stackoverflow.com/questions/30179442
log_breaks = function(maj, radix=10) {
  function(x) {
    minx = floor(min(logb(x, radix), na.rm=T)) - 1
    maxx = ceiling(max(logb(x, radix), na.rm=T)) + 1
    n_major = maxx - minx + 1
    major_breaks = minx:maxx
    if (maj) {
      breaks = major_breaks
    } else {
      breaks = rep(logb(1:(radix-1), radix), times=n_major) +
               rep(major_breaks, each=radix-1)
    }
    radix^breaks
  }
}
# See https://github.com/tidyverse/ggplot2/blob/master/R/scale-continuous.r#L160
scale_x_log_eng = function(..., radix=10) {
  scale_x_continuous(..., trans=log_trans(radix),
                     breaks=log_breaks(T, radix),
                     minor_breaks=log_breaks(F, radix))
}
scale_y_log_eng = function(..., radix=10) {
  scale_y_continuous(..., trans=log_trans(radix),
                     breaks=log_breaks(T, radix),
                     minor_breaks=log_breaks(F, radix))
}
xaxis_text_vert = function() {
  theme(axis.text.x=element_text(angle=90))
}


# Plotting #################################################################

do_graph = function(gc_en, gc_title) {
    to_graph = times[times$GC == gc_en,]
    cross = 3
    ggplot(to_graph, aes(x=Size, y=Throughput, colour=Method)) +
        facet_grid(.~Version) +
        geom_line() + geom_point(shape=cross) +
        xaxis_text_vert() + scale_x_log_eng() +
        labs(title=sprintf('String append across Python versions (GC %s)', gc_title),
             # Adapt this for non-Mac
             subtitle=system('sysctl -n machdep.cpu.brand_string', intern=TRUE),
             x='Input size (bytes)', y='Throughput (bytes/s)')
}

do_graph(FALSE, 'disabled')
do_graph(TRUE, 'enabled')
