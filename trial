#!/usr/bin/env python

from operator import concat
from sys import version, version_info
from timeit import repeat  # Compatibility: ver >= 2.6

# ver = version.partition('\n')[0].rstrip()
ver = '.'.join(str(v) for v in version_info[:3])
print(ver)

if version_info[0] == 2:
    from StringIO import StringIO
else:
    from io import StringIO
    from functools import reduce
    xrange = range


def build_plus():
    output = ''
    for _ in xrange(input_len):
        output += 'a'
    return output


def build_join():
    return ''.join('a' for _ in xrange(input_len))


def build_bytes_plus():
    output = b''
    for _ in xrange(input_len):
        output += b'a'
    return output


def build_stringio():
    output = StringIO()
    for _ in xrange(input_len):
        output.write('a')
    return output.getvalue()


def build_reduce():
    return reduce(concat, ('a' for _ in xrange(input_len)))


builds = {'str+': build_plus,
          'join': build_join,
          'reduce': build_reduce,
          'bytes+': build_bytes_plus,
          'StringIO': build_stringio}

if version_info[0] == 2:
    import cStringIO

    def build_cstringio():
        output = cStringIO.StringIO()
        for _ in xrange(input_len):
            output.write('a')
        return output.getvalue()

    builds['cStringIO'] = build_cstringio
else:
    from io import BytesIO

    def build_bytesio():
        output = BytesIO()
        for _ in xrange(input_len):
            output.write(b'a')
        return output.getvalue()

    builds['BytesIO'] = build_bytesio

resfile = open('times.csv', 'a')
max_order = 6

for allow_gc in (False, True):
    setup = 'gc.enable()' if allow_gc else 'pass'

    for build_name, build_fun in builds.items():
        for input_len_exp in range(1, max_order):
            input_len = 10**input_len_exp
            reps = 10**(max_order - 1 - input_len_exp)

            # Without calling repeat(), the CSV is about 20k. If we let it get to 2M,
            # we can allow for a repeat count of up to 100.
            number = int(max(1, reps/100))
            n_repeat = int(reps / number)

            durs = repeat(build_fun, setup, repeat=n_repeat, number=number)

            prefix = '"%s",%s,"%s",%d,' % (ver, str(allow_gc).upper(), build_name, input_len)
            for dur in durs:
                resfile.write(prefix + '%.6g\n' % dur)
